<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cardiovascular Pulse Timing Simulation</title>
    <!-- Importing Libraries -->
    <script type="importmap">
      {
        "imports": {
          "p5": "https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js",
          "es": "https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"
        }
      }
    </script>
    <!-- Styling -->
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100vh;
        overflow: hidden;
        color: #333;
      }

      .container {
        display: grid;
        grid-template-columns: 1fr 2fr 1fr;
        grid-template-rows: auto 1fr auto auto;
        height: 100vh;
        min-height: 0;
        gap: 1rem;
        padding: 1rem;
        overflow: hidden;
      }

      .controls-panel,
      .simulation-area,
      .metrics-panel {
        min-height: 0;
        overflow: auto;
      }

      .header {
        grid-column: 1 / -1;
        text-align: center;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 1rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        color: #2c3e50;
        font-size: clamp(1.5rem, 4vw, 2.5rem);
        font-weight: 700;
        margin-bottom: 0.5rem;
      }

      .header p {
        color: #7f8c8d;
        font-size: clamp(0.9rem, 2vw, 1.1rem);
        max-width: 800px;
        margin: 0 auto;
      }

      .controls-panel {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .controls-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #2c3e50;
        text-align: center;
        margin-bottom: 0.5rem;
      }

      .control-group {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 10px;
        border-left: 4px solid #3498db;
      }

      .control-group label {
        display: block;
        margin-bottom: 0.8rem;
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.95rem;
      }

      input[type="range"] {
        width: 100%;
        height: 8px;
        border-radius: 5px;
        background: #ddd;
        outline: none;
        -webkit-appearance: none;
        appearance: none;
        margin-bottom: 0.5rem;
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #3498db;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }

      input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #3498db;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }

      .value-display {
        font-size: 1rem;
        font-weight: 600;
        color: #3498db;
        text-align: center;
        background: white;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        display: inline-block;
        min-width: 60px;
      }

      .simulation-area {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 1rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        width: 100%;
        height: 100%;
      }

      .metrics-panel {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .metrics-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #2c3e50;
        text-align: center;
        margin-bottom: 1rem;
      }

      .metrics {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .metric {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
        border-left: 4px solid #e74c3c;
      }

      .metric-label {
        font-size: 0.9rem;
        color: #7f8c8d;
        margin-bottom: 0.3rem;
        font-weight: 500;
      }

      .metric-value {
        font-size: 1.4rem;
        font-weight: 700;
        color: #2c3e50;
      }

      /* Legend Panel Styles */
      .legend-panel {
        grid-column: 1 / -1;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 1rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        align-items: center;
        gap: 1rem;
      }

      .legend-title {
        width: 100%;
        text-align: center;
        font-size: 1.2rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.5rem;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        color: #2c3e50;
        font-weight: 500;
      }

      .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }

      .artery-color { background-color: #dc3545; }
      .vein-color { background-color: #007bff; }
      .pulmonary-color { background-color: #6f42c1; }
      .arterial-pulse-color { background-color: #fd7e14; }
      .venous-pulse-color { background-color: #17a2b8; }

      .instructions {
        grid-column: 1 / -1;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 1rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        text-align: center;
        flex-shrink: 0;
      }

      .instructions p {
        color: #7f8c8d;
        font-size: 0.9rem;
        margin: 0;
      }

      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.8rem 1.5rem;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }

      /* Responsive Design */
      @media (max-width: 1200px) {
        .container {
          grid-template-columns: 1fr 1.5fr 1fr;
        }
      }

      @media (max-width: 900px) {
        .container {
          grid-template-columns: 1fr;
          grid-template-rows: auto auto 1fr auto auto auto;
          gap: 0.8rem;
          padding: 0.8rem;
        }

        .controls-panel {
          order: 2;
        }

        .simulation-area {
          order: 3;
          min-height: 300px;
        }

        .metrics-panel {
          order: 4;
        }

        .legend-panel {
          order: 5;
        }

        .instructions {
          order: 6;
        }

        .metrics {
          flex-direction: row;
          justify-content: space-between;
        }

        .metric {
          flex: 1;
          margin: 0 0.2rem;
          padding: 0.8rem 0.5rem;
        }

        .metric-value {
          font-size: 1.2rem;
        }

        .legend-item {
          font-size: 0.8rem;
        }
      }

      @media (max-width: 600px) {
        .container {
          padding: 0.5rem;
          gap: 0.5rem;
        }

        .controls-panel,
        .metrics-panel,
        .legend-panel {
          padding: 1rem;
        }

        .header {
          padding: 0.8rem;
        }

        .metrics {
          flex-direction: column;
          gap: 0.5rem;
        }

        .metric {
          margin: 0;
          padding: 0.8rem;
        }

        .legend-item {
          font-size: 0.7rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <h1>Cardiovascular Pulse Timing Simulation</h1>
        <p>
          Interactive 2D simulation with realistic pulse wave velocities - 
          Visualize how heartbeats travel at different speeds through arteries (faster) and veins (slower)
        </p>
      </header>

      <div class="controls-panel">
        <div class="controls-title">Pulse Parameters</div>
        <div class="control-group">
          <label for="heart-rate">Heart Rate (BPM)</label>
          <input
            type="range"
            id="heart-rate"
            min="40"
            max="180"
            step="1"
            value="72"
          />
          <div style="text-align: center">
            <span id="heart-rate-value" class="value-display">72 BPM</span>
          </div>
        </div>
        <div class="control-group">
          <label for="pulse-velocity">Base Pulse Velocity</label>
          <input
            type="range"
            id="pulse-velocity"
            min="3"
            max="8"
            step="0.1"
            value="5.0"
          />
          <div style="text-align: center">
            <span id="pulse-velocity-value" class="value-display">5.0 m/s</span>
          </div>
          <div style="font-size: 0.8rem; color: #666; text-align: center; margin-top: 0.5rem;">
            Arteries: 1.2x faster | Veins: 0.7x slower
          </div>
        </div>
        <button id="reset-btn">Reset Simulation</button>
      </div>

      <div class="simulation-area">
        <div id="simulation-container"></div>
      </div>

      <div class="metrics-panel">
        <div class="metrics-title">Pulse Metrics</div>
        <div class="metrics">
          <div class="metric">
            <div class="metric-label">Active Pulses</div>
            <div id="active-pulses" class="metric-value">0</div>
          </div>
          <div class="metric">
            <div class="metric-label">Arterial Speed</div>
            <div id="arterial-speed" class="metric-value">6.0</div>
            <div style="font-size: 0.8rem; color: #95a5a6">m/s</div>
          </div>
          <div class="metric">
            <div class="metric-label">Venous Speed</div>
            <div id="venous-speed" class="metric-value">3.5</div>
            <div style="font-size: 0.8rem; color: #95a5a6">m/s</div>
          </div>
          <div class="metric">
            <div class="metric-label">Beat Interval</div>
            <div id="beat-interval" class="metric-value">833</div>
            <div style="font-size: 0.8rem; color: #95a5a6">ms</div>
          </div>
        </div>
      </div>

      <!-- Legend Panel -->
      <div class="legend-panel">
        <div class="legend-title">Vessel & Pulse Legend</div>
        <div class="legend-item">
          <div class="legend-color artery-color"></div>
          <span>Arteries (Fast: <span id="legend-arterial-speed">6.0</span> m/s)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color vein-color"></div>
          <span>Veins (Slow: <span id="legend-venous-speed">3.5</span> m/s)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color pulmonary-color"></div>
          <span>Pulmonary Veins (<span id="legend-pulmonary-speed">5.0</span> m/s)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color arterial-pulse-color"></div>
          <span>Arterial Pulses (Outward, Larger)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color venous-pulse-color"></div>
          <span>Venous Pulses (Inward, Smaller)</span>
        </div>
      </div>

      <div class="instructions">
        <p>
          Watch pulse waves travel at realistic speeds. Arterial pulses flow away from the heart, venous pulses flow toward the heart.
        </p>
      </div>
    </div>

    <script type="module">
      import "p5";
      import "es";

      const sketch = (p) => {
        // === Simulation Parameters ===
        const FPS = 60;
        const CANVAS_WIDTH = 800;  // Fixed canvas width
        const CANVAS_HEIGHT = 600; // Fixed canvas height
        
        let heartRate = 72;
        let basePulseVelocity = 5.0;
        let beatInterval = 60000 / heartRate;
        let lastBeatTime = 0;
        let heartScale = 1;
        
        // Velocity multipliers for different vessel types
        const VELOCITY_MULTIPLIERS = {
          'artery': 1.2,
          'vein': 0.7,
          'pulmonary': 1.0
        };
        
        let pulseWaves = [];
        let vessels = [];
        let humanBodyImg;
        let imgLoaded = false;
        
        // UI elements
        let heartRateSlider, pulseVelocitySlider, resetBtn;
        let heartRateValue, pulseVelocityValue;
        let activePulsesDisplay, beatIntervalDisplay, arterialSpeedDisplay, venousSpeedDisplay;
        let legendArterialSpeed, legendVenousSpeed, legendPulmonarySpeed;

        // Heart position constants
        const HEART_X = -20;
        const HEART_Y = 0;

        // Enhanced PulseWave Class with proper direction support for veins
        class PulseWave {
          constructor(vessel, startTime) {
            this.vessel = vessel;
            this.startTime = startTime;
            this.position = 0;
            this.maxDistance = this.calculateVesselLength();
            this.active = true;
            this.opacity = 1;
            
            this.velocityMultiplier = this.getVelocityMultiplier();
            this.actualVelocity = basePulseVelocity * this.velocityMultiplier;
            
            // Direction based on vessel type
            this.direction = this.getFlowDirection();
          }
          
          // Get velocity multiplier based on vessel type
          getVelocityMultiplier() {
            if (this.vessel.color[0] === 220 && this.vessel.color[2] === 220) {
              return VELOCITY_MULTIPLIERS.pulmonary;
            } else if (this.vessel.type === 'artery') {
              return VELOCITY_MULTIPLIERS.artery;
            } else {
              return VELOCITY_MULTIPLIERS.vein;
            }
          }
          
          // Determine flow direction based on vessel type
          getFlowDirection() {
            if (this.vessel.type === 'vein') {
              return -1; // Veins flow toward heart (reverse direction)
            } else {
              return 1;  // Arteries flow away from heart (normal direction)
            }
          }
          
          // Calculate total vessel path length
          calculateVesselLength() {
            let length = 0;
            for (let i = 1; i < this.vessel.path.length; i++) {
              const dx = this.vessel.path[i].x - this.vessel.path[i-1].x;
              const dy = this.vessel.path[i].y - this.vessel.path[i-1].y;
              length += Math.sqrt(dx * dx + dy * dy);
            }
            return length;
          }
          
          // Update pulse position and opacity
          update(currentTime) {
            const elapsedTime = (currentTime - this.startTime) / 1000;
            const pixelVelocity = this.actualVelocity * 25;
            
            // Apply direction to position calculation
            if (this.direction === -1) {
              // For veins: start from end and move toward beginning (toward heart)
              this.position = this.maxDistance - (elapsedTime * pixelVelocity);
            } else {
              // For arteries: normal direction (away from heart)
              this.position = elapsedTime * pixelVelocity;
            }
            
            // Fade out logic adjusted for direction
            if (this.direction === -1) {
              // Veins: fade as approaching heart
              if (this.position < this.maxDistance * 0.2) {
                this.opacity = p.map(this.position, 0, this.maxDistance * 0.2, 0, 1);
              }
              if (this.position < -30) {
                this.active = false;
              }
            } else {
              // Arteries: fade as moving away from heart
              if (this.position > this.maxDistance * 0.8) {
                this.opacity = p.map(this.position, this.maxDistance * 0.8, this.maxDistance, 1, 0);
              }
              if (this.position > this.maxDistance + 30) {
                this.active = false;
              }
            }
          }
          
          // Get position coordinates on vessel path
          getPositionOnPath() {
            let targetPosition = this.position;
            
            // Ensure position is within bounds
            if (targetPosition <= 0) return this.vessel.path[0];
            if (targetPosition >= this.maxDistance) return this.vessel.path[this.vessel.path.length - 1];
            
            let currentLength = 0;
            for (let i = 1; i < this.vessel.path.length; i++) {
              const dx = this.vessel.path[i].x - this.vessel.path[i-1].x;
              const dy = this.vessel.path[i].y - this.vessel.path[i-1].y;
              const segmentLength = Math.sqrt(dx * dx + dy * dy);
              
              if (currentLength + segmentLength >= targetPosition) {
                const ratio = (targetPosition - currentLength) / segmentLength;
                return {
                  x: this.vessel.path[i-1].x + dx * ratio,
                  y: this.vessel.path[i-1].y + dy * ratio
                };
              }
              currentLength += segmentLength;
            }
            return this.vessel.path[this.vessel.path.length - 1];
          }
        }

        // Initialize vessel network with corrected vein paths
        function initializeVessels() {
          vessels = [
            // === ARTERIES (flow away from heart) ===
            {
              path: [
                {x: HEART_X, y: HEART_Y},
                {x: HEART_X - 10, y: HEART_Y - 30},
                {x: HEART_X - 20, y: HEART_Y - 60},
                {x: HEART_X - 30, y: HEART_Y - 90}
              ],
              color: [220, 50, 50],
              type: 'artery',
              width: 12,
              importance: 'major'
            },
            {
              path: [
                {x: HEART_X - 30, y: HEART_Y - 90},
                {x: HEART_X - 10, y: HEART_Y - 95},
                {x: HEART_X + 15, y: HEART_Y - 100},
                {x: HEART_X + 35, y: HEART_Y - 105}
              ],
              color: [220, 50, 50],
              type: 'artery',
              width: 8,
              importance: 'major'
            },
            {
              path: [
                {x: HEART_X - 30, y: HEART_Y - 90},
                {x: HEART_X - 32, y: HEART_Y - 110},
                {x: HEART_X - 28, y: HEART_Y - 140},
                {x: HEART_X - 25, y: HEART_Y - 170},
                {x: HEART_X - 20, y: HEART_Y - 200}
              ],
              color: [220, 50, 50],
              type: 'artery',
              width: 6,
              importance: 'medium'
            },
            {
              path: [
                {x: HEART_X + 35, y: HEART_Y - 105},
                {x: HEART_X + 32, y: HEART_Y - 125},
                {x: HEART_X + 28, y: HEART_Y - 150},
                {x: HEART_X + 25, y: HEART_Y - 175},
                {x: HEART_X + 20, y: HEART_Y - 200}
              ],
              color: [220, 50, 50],
              type: 'artery',
              width: 6,
              importance: 'medium'
            },
            {
              path: [
                {x: HEART_X - 30, y: HEART_Y - 90},
                {x: HEART_X - 45, y: HEART_Y - 85},
                {x: HEART_X - 65, y: HEART_Y - 80},
                {x: HEART_X - 90, y: HEART_Y - 75},
                {x: HEART_X - 115, y: HEART_Y - 70},
                {x: HEART_X - 140, y: HEART_Y - 65}
              ],
              color: [220, 50, 50],
              type: 'artery',
              width: 6,
              importance: 'medium'
            },
            {
              path: [
                {x: HEART_X + 35, y: HEART_Y - 105},
                {x: HEART_X + 55, y: HEART_Y - 95},
                {x: HEART_X + 75, y: HEART_Y - 85},
                {x: HEART_X + 100, y: HEART_Y - 80},
                {x: HEART_X + 125, y: HEART_Y - 75},
                {x: HEART_X + 150, y: HEART_Y - 70}
              ],
              color: [220, 50, 50],
              type: 'artery',
              width: 6,
              importance: 'medium'
            },
            {
              path: [
                {x: HEART_X - 30, y: HEART_Y - 90},
                {x: HEART_X - 32, y: HEART_Y - 50},
                {x: HEART_X - 30, y: HEART_Y - 10},
                {x: HEART_X - 28, y: HEART_Y + 30},
                {x: HEART_X - 25, y: HEART_Y + 70},
                {x: HEART_X - 20, y: HEART_Y + 110}
              ],
              color: [220, 50, 50],
              type: 'artery',
              width: 10,
              importance: 'major'
            },

            // === VEINS (flow toward heart) - CORRECTED PATHS ===
            {
              // CORRECTED: Reversed path so pulses start from periphery and flow toward heart
              path: [
                {x: HEART_X + 30, y: HEART_Y - 10},
                {x: HEART_X + 32, y: HEART_Y - 40},
                {x: HEART_X + 35, y: HEART_Y - 70},
                {x: HEART_X + 38, y: HEART_Y - 100},
                {x: HEART_X + 40, y: HEART_Y - 130}
              ],
              color: [50, 100, 220],
              type: 'vein',
              width: 10,
              importance: 'major'
            },
            {
              // CORRECTED: Reversed path
              path: [
                {x: HEART_X + 40, y: HEART_Y - 130},
                {x: HEART_X + 38, y: HEART_Y - 150},
                {x: HEART_X + 35, y: HEART_Y - 175},
                {x: HEART_X + 30, y: HEART_Y - 200}
              ],
              color: [50, 100, 220],
              type: 'vein',
              width: 5,
              importance: 'medium'
            },
            {
              // CORRECTED: Reversed path
              path: [
                {x: HEART_X + 40, y: HEART_Y - 130},
                {x: HEART_X + 10, y: HEART_Y - 135},
                {x: HEART_X - 15, y: HEART_Y - 145},
                {x: HEART_X - 30, y: HEART_Y - 160},
                {x: HEART_X - 35, y: HEART_Y - 180},
                {x: HEART_X - 38, y: HEART_Y - 200}
              ],
              color: [50, 100, 220],
              type: 'vein',
              width: 5,
              importance: 'medium'
            },
            {
              // CORRECTED: Reversed path
              path: [
                {x: HEART_X + 40, y: HEART_Y - 130},
                {x: HEART_X + 65, y: HEART_Y - 125},
                {x: HEART_X + 90, y: HEART_Y - 115},
                {x: HEART_X + 115, y: HEART_Y - 105},
                {x: HEART_X + 140, y: HEART_Y - 95},
                {x: HEART_X + 160, y: HEART_Y - 85}
              ],
              color: [50, 100, 220],
              type: 'vein',
              width: 5,
              importance: 'medium'
            },
            {
              // CORRECTED: Reversed path
              path: [
                {x: HEART_X + 40, y: HEART_Y - 130},
                {x: HEART_X + 5, y: HEART_Y - 135},
                {x: HEART_X - 25, y: HEART_Y - 125},
                {x: HEART_X - 55, y: HEART_Y - 115},
                {x: HEART_X - 85, y: HEART_Y - 105},
                {x: HEART_X - 115, y: HEART_Y - 95},
                {x: HEART_X - 145, y: HEART_Y - 85}
              ],
              color: [50, 100, 220],
              type: 'vein',
              width: 5,
              importance: 'medium'
            },
            {
              // CORRECTED: Reversed path
              path: [
                {x: HEART_X + 20, y: HEART_Y + 30},
                {x: HEART_X + 22, y: HEART_Y + 60},
                {x: HEART_X + 25, y: HEART_Y + 90},
                {x: HEART_X + 28, y: HEART_Y + 120}
              ],
              color: [50, 100, 220],
              type: 'vein',
              width: 8,
              importance: 'major'
            },

            // === PULMONARY VESSELS ===
            {
              path: [
                {x: HEART_X - 80, y: HEART_Y - 35},
                {x: HEART_X - 60, y: HEART_Y - 25},
                {x: HEART_X - 35, y: HEART_Y - 15},
                {x: HEART_X - 10, y: HEART_Y - 10}
              ],
              color: [220, 50, 220],
              type: 'pulmonary',
              width: 4,
              importance: 'medium'
            },
            {
              path: [
                {x: HEART_X + 70, y: HEART_Y - 35},
                {x: HEART_X + 50, y: HEART_Y - 25},
                {x: HEART_X + 25, y: HEART_Y - 15},
                {x: HEART_X - 10, y: HEART_Y - 10}
              ],
              color: [220, 50, 220],
              type: 'pulmonary',
              width: 4,
              importance: 'medium'
            }
          ];
        }

        // Preload human body background image
        p.preload = () => {
          humanBodyImg = p.loadImage('https://as1.ftcdn.net/jpg/02/24/24/06/1000_F_224240638_9cg17hGtJw54J4kLjLNsU6EfYiBoJUcI.jpg', 
            () => { imgLoaded = true; },
            (err) => { console.log('Image load failed:', err); }
          );
        };

        // Setup function - initialize canvas and UI elements
        p.setup = () => {
          // Fixed canvas size
          let canvas = p.createCanvas(CANVAS_WIDTH, CANVAS_HEIGHT);
          canvas.parent("simulation-container");

          initializeVessels();
          
          // Initialize UI elements
          heartRateSlider = document.getElementById("heart-rate");
          pulseVelocitySlider = document.getElementById("pulse-velocity");
          resetBtn = document.getElementById("reset-btn");
          heartRateValue = document.getElementById("heart-rate-value");
          pulseVelocityValue = document.getElementById("pulse-velocity-value");
          activePulsesDisplay = document.getElementById("active-pulses");
          beatIntervalDisplay = document.getElementById("beat-interval");
          arterialSpeedDisplay = document.getElementById("arterial-speed");
          venousSpeedDisplay = document.getElementById("venous-speed");
          
          // Legend elements
          legendArterialSpeed = document.getElementById("legend-arterial-speed");
          legendVenousSpeed = document.getElementById("legend-venous-speed");
          legendPulmonarySpeed = document.getElementById("legend-pulmonary-speed");

          // Event listeners
          heartRateSlider.addEventListener("input", updateHeartRate);
          pulseVelocitySlider.addEventListener("input", updatePulseVelocity);
          resetBtn.addEventListener("click", resetSimulation);

          p.frameRate(FPS);
          lastBeatTime = p.millis();
        };

        // Main draw loop
        p.draw = () => {
          drawBackground();
          
          p.push();
          p.translate(p.width / 2, p.height / 2);
          
          if (imgLoaded && humanBodyImg) {
            drawHumanBackground();
          }
          
          updateHeartBeat();
          drawVessels();
          drawAnatomicalHeart();
          updatePulseWaves();
          drawPulseWaves();
          
          p.pop();
          
          updateMetrics();
          updateLegendValues();
        };

        // Draw background gradient
        function drawBackground() {
          p.background(245, 250, 255);
        }

        // Draw human body silhouette background
        function drawHumanBackground() {
          p.push();
          p.tint(255, 180);
          
          // Fixed scaling for consistent image display
          const SCALE = 2.5; 
          const w = CANVAS_WIDTH * SCALE;
          const h = CANVAS_HEIGHT * SCALE;
          p.image(humanBodyImg, -w/1.95, -h/3.8 , w, h);
          p.pop();
        }

        // Draw all blood vessels
        function drawVessels() {
          vessels.forEach(vessel => {
            p.stroke(vessel.color[0], vessel.color[1], vessel.color[2]);
            p.strokeWeight(vessel.width);
            p.noFill();
            
            // Draw vessel path with smooth curves for longer paths
            if (vessel.path.length >= 4) {
              p.beginShape();
              p.vertex(vessel.path[0].x, vessel.path[0].y);
              
              for (let i = 1; i < vessel.path.length - 2; i++) {
                let cp1x = vessel.path[i].x;
                let cp1y = vessel.path[i].y;
                let cp2x = vessel.path[i + 1].x;
                let cp2y = vessel.path[i + 1].y;
                let x = vessel.path[i + 2].x;
                let y = vessel.path[i + 2].y;
                
                p.bezierVertex(cp1x, cp1y, cp2x, cp2y, x, y);
              }
              p.endShape();
            } else {
              // Simple line for shorter paths
              p.beginShape();
              vessel.path.forEach(point => {
                p.vertex(point.x, point.y);
              });
              p.endShape();
            }
            
            // Add glow effect
            p.stroke(vessel.color[0], vessel.color[1], vessel.color[2], 80);
            p.strokeWeight(vessel.width + 4);
            if (vessel.path.length >= 4) {
              p.beginShape();
              p.vertex(vessel.path[0].x, vessel.path[0].y);
              
              for (let i = 1; i < vessel.path.length - 2; i++) {
                let cp1x = vessel.path[i].x;
                let cp1y = vessel.path[i].y;
                let cp2x = vessel.path[i + 1].x;
                let cp2y = vessel.path[i + 1].y;
                let x = vessel.path[i + 2].x;
                let y = vessel.path[i + 2].y;
                
                p.bezierVertex(cp1x, cp1y, cp2x, cp2y, x, y);
              }
              p.endShape();
            }
          });
        }

        // Draw anatomical heart with realistic shape and details
        function drawAnatomicalHeart() {
          p.push();
          p.translate(HEART_X, HEART_Y);
          p.scale(heartScale);
          
          // Heart shadow
          p.fill(0, 0, 0, 30);
          p.noStroke();
          p.push();
          p.translate(3, 3);
          drawRealisticHeartShape();
          p.pop();
          
          // Main heart with gradient
          drawHeartGradient();
          
          // Heart outline
          p.stroke(160, 40, 60);
          p.strokeWeight(2);
          p.noFill();
          drawRealisticHeartShape();
          
          // Coronary vessels on heart surface
          p.stroke(180, 50, 70);
          p.strokeWeight(1);
          p.noFill();
          p.bezier(-15, -20, -25, -10, -20, 10, -10, 25);
          p.bezier(-15, -20, -5, -15, 8, -8, 15, 8);
          p.bezier(12, -15, 20, -8, 25, 12, 20, 30);
          
          p.pop();
        }

        // Draw realistic heart shape
        function drawRealisticHeartShape() {
          p.beginShape();
          p.vertex(0, -25);
          p.bezierVertex(20, -30, 30, -20, 28, -8);
          p.bezierVertex(32, 12, 25, 25, 12, 35);
          p.bezierVertex(6, 42, -6, 42, -12, 35);
          p.bezierVertex(-25, 25, -32, 12, -28, -8);
          p.bezierVertex(-30, -20, -20, -30, 0, -25);
          p.endShape(p.CLOSE);
        }

        // Draw heart with gradient fill effect
        function drawHeartGradient() {
          let steps = 12;
          for (let i = 0; i < steps; i++) {
            let alpha = p.map(i, 0, steps, 0.9, 0.3);
            let r = p.map(i, 0, steps, 180, 220);
            let g = p.map(i, 0, steps, 40, 80);
            let b = p.map(i, 0, steps, 60, 100);
            
            p.fill(r, g, b, alpha * 255);
            p.noStroke();
            p.push();
            p.scale(1 - i * 0.05);
            drawRealisticHeartShape();
            p.pop();
          }
        }

        // Update heart beat animation and create new pulse waves
        function updateHeartBeat() {
          const currentTime = p.millis();
          
          if (currentTime - lastBeatTime >= beatInterval) {
            // Create new pulse wave for each vessel
            vessels.forEach(vessel => {
              pulseWaves.push(new PulseWave(vessel, currentTime));
            });
            
            lastBeatTime = currentTime;
            heartScale = 1.2; // Heart contraction effect
          }
          
          // Smooth heart scale animation
          heartScale = p.lerp(heartScale, 1, 0.08);
        }

        // Update all active pulse waves
        function updatePulseWaves() {
          const currentTime = p.millis();
          pulseWaves = pulseWaves.filter(wave => {
            wave.update(currentTime);
            return wave.active;
          });
        }

        // Render all pulse waves with appropriate colors and sizes
        function drawPulseWaves() {
          pulseWaves.forEach(wave => {
            if ((wave.direction === 1 && wave.position > 0) || 
                (wave.direction === -1 && wave.position < wave.maxDistance)) {
              const pos = wave.getPositionOnPath();
              
              p.push();
              p.translate(pos.x, pos.y);
              
              let pulseColor;
              let pulseSize;
              
              // Determine pulse appearance based on vessel type
              if (wave.vessel.color[0] === 220 && wave.vessel.color[2] === 220) {
                // Pulmonary vessels
                pulseColor = [255, 100, 255];
                pulseSize = 1.0;
              } else if (wave.vessel.type === 'artery') {
                // Arterial pulses (orange/yellow)
                pulseColor = [255, 200, 100];
                pulseSize = 1.2;
              } else {
                // Venous pulses (blue/cyan)
                pulseColor = [100, 200, 255];
                pulseSize = 0.8;
              }
              
              let maxRadius = 25 * pulseSize;
              let intensityBoost = wave.velocityMultiplier;
              
              // Draw pulse with radial gradient effect
              for (let r = maxRadius; r > 0; r -= 5) {
                const alpha = (wave.opacity * 180 * intensityBoost * (maxRadius - r)) / maxRadius;
                p.fill(pulseColor[0], pulseColor[1], pulseColor[2], alpha);
                p.noStroke();
                p.ellipse(0, 0, r, r);
              }
              
              // Draw pulse core
              let coreSize = 8 * pulseSize;
              p.fill(pulseColor[0], pulseColor[1], pulseColor[2], wave.opacity * 255);
              p.stroke(255, 255, 255, wave.opacity * 200);
              p.strokeWeight(1);
              p.ellipse(0, 0, coreSize, coreSize);
              
              p.pop();
            }
          });
        }

        // Update heart rate from slider
        function updateHeartRate() {
          heartRate = parseInt(heartRateSlider.value);
          beatInterval = 60000 / heartRate;
          heartRateValue.textContent = heartRate + " BPM";
        }

        // Update base pulse velocity from slider
        function updatePulseVelocity() {
          basePulseVelocity = parseFloat(pulseVelocitySlider.value);
          pulseVelocityValue.textContent = basePulseVelocity.toFixed(1) + " m/s";
        }

        // Reset simulation to default values
        function resetSimulation() {
          heartRate = 72;
          basePulseVelocity = 5.0;
          beatInterval = 60000 / heartRate;
          heartRateSlider.value = heartRate;
          pulseVelocitySlider.value = basePulseVelocity;
          heartRateValue.textContent = heartRate + " BPM";
          pulseVelocityValue.textContent = basePulseVelocity.toFixed(1) + " m/s";
          pulseWaves = [];
          heartScale = 1;
          lastBeatTime = p.millis();
        }

        // Update metrics display panel
        function updateMetrics() {
          const arterialSpeed = basePulseVelocity * VELOCITY_MULTIPLIERS.artery;
          const venousSpeed = basePulseVelocity * VELOCITY_MULTIPLIERS.vein;
          
          activePulsesDisplay.textContent = pulseWaves.length;
          beatIntervalDisplay.textContent = Math.round(beatInterval);
          arterialSpeedDisplay.textContent = arterialSpeed.toFixed(1);
          venousSpeedDisplay.textContent = venousSpeed.toFixed(1);
        }

        // Update legend values display
        function updateLegendValues() {
          const arterialSpeed = basePulseVelocity * VELOCITY_MULTIPLIERS.artery;
          const venousSpeed = basePulseVelocity * VELOCITY_MULTIPLIERS.vein;
          const pulmonarySpeed = basePulseVelocity * VELOCITY_MULTIPLIERS.pulmonary;
          
          legendArterialSpeed.textContent = arterialSpeed.toFixed(1);
          legendVenousSpeed.textContent = venousSpeed.toFixed(1);
          legendPulmonarySpeed.textContent = pulmonarySpeed.toFixed(1);
        }
      };

      // Create the p5 instance
      new p5(sketch);
    </script>
  </body>
</html>
